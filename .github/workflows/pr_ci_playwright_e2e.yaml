name: pr_ci_playwright_e2e
on:
  workflow_dispatch:

jobs:
  frontend:
    name: Run PR Frontend E2E Check
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Cleanup Old Checkout
        run: chmod +w -R ${GITHUB_WORKSPACE}; rm -rf ${GITHUB_WORKSPACE}/*;

      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Clean Any Existing Containers
        run: |
          docker stop $(docker ps -aq) || true
          docker rm $(docker ps -aq) || true

      - name: Check Port Availability
        run: |
          ! nc -z localhost 3000 && \
          ! nc -z localhost 8000 && \
          ! nc -z localhost 5432

      - name: Run Docker Compose
        run: docker compose --env-file .env.dev up --build -d backend db

      - name: Wait for Database
        run: |
          timeout 60 bash -c 'until docker compose --env-file .env.dev exec -T db pg_isready -U postgres; do sleep 2; done'

      - name: Wait for Backend
        run: |
          timeout 90 bash -c 'until curl -s http://localhost:8000 >/dev/null; do sleep 2; done'

      - name: Setup Node Environment
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - uses: c-py/action-dotenv-to-setenv@v5
        with:
          env-file: .env.dev

      - name: Install Dependencies and Build
        working-directory: ./frontend
        env:
          VITE_FRONTEND_URL: http://localhost:3000
          VITE_BACKEND_URL: http://localhost:8000
          VITE_API_URL: http://localhost:8000/v1
        run: |
          sudo corepack enable
          sudo yarn install
          sudo -E yarn build

          if [ ! -f "dist/index.html" ]; then
            echo "Build failed: dist/index.html not found"
            exit 1
          fi

      - name: Install Playwright Browsers
        working-directory: ./frontend
        env:
          PLAYWRIGHT_BROWSERS_PATH: /opt/playwright-browsers
        run: |
          sudo mkdir -p /opt/playwright-browsers
          sudo -E yarn playwright install --with-deps chromium
          sudo chmod -R 755 /opt/playwright-browsers

      - name: Start Static Server
        working-directory: ./frontend
        run: |
          npm install -g serve
          nohup serve dist -l 3000 > server.log 2>&1 &
          echo $! > server.pid
          sleep 3

          if ! ps -p $(cat server.pid) > /dev/null; then
            echo "Server failed to start:"
            cat server.log
            exit 1
          fi

      - name: Wait for Frontend
        working-directory: ./frontend
        run: |
          yarn wait-on http://localhost:3000 --timeout 60000 || {
            echo "Frontend server not responding:"
            cat server.log
            exit 1
          }

      - name: Warm Up Backend
        run: |
          curl -s -X OPTIONS http://localhost:8000/v1/auth/sign_in > /dev/null || true
          curl -s http://localhost:8000/v1/entities/users/ > /dev/null || true
          curl -s http://localhost:8000/v1/entities/organizations/ > /dev/null || true
          curl -s http://localhost:8000/v1/entities/events/ > /dev/null || true
          sleep 3

      - name: Run Playwright Tests
        working-directory: ./frontend
        env:
          FAST_TESTS: true # only Desktop Chrome + Mobile Chrome
          SKIP_WEBSERVER: true # Server already started manually
          PLAYWRIGHT_BROWSERS_PATH: /opt/playwright-browsers
        run: sudo -E yarn playwright test

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30
