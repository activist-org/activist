services:
  db:
    extends:
      file: docker-compose.yml
      service: db
    ports:
      - "${DATABASE_PORT}:${DATABASE_PORT}"

  backend:
    extends:
      file: docker-compose.yml
      service: backend
    depends_on:
      - db
    ports:
      - "${BACKEND_PORT}:${BACKEND_PORT}"

  frontend:
    env_file:
      - .env.dev
    build:
      context: ./frontend
      dockerfile: e2e.Dockerfile # note: using the e2e Dockerfile
    container_name: nuxt_frontend
    # Use USE_PREVIEW=true to run pre-built version (faster for E2E tests).
    command: sh -c "
      corepack enable && yarn install &&
      echo 'üèóÔ∏è  Building frontend for preview mode...' &&
      yarn build &&
      echo '‚ñ∂Ô∏è  Starting preview server on port ${FRONTEND_PORT}...' &&
      yarn preview --port ${FRONTEND_PORT};"
    volumes:
      - ./frontend:/app
    ports:
      - "${FRONTEND_PORT}:${FRONTEND_PORT}"
      - "24678:24678"
    environment:
      - USE_PREVIEW=${USE_PREVIEW:-true} # note: set to true

  e2e-test:
    env_file:
      - .env.dev
    depends_on:
      - backend
      - frontend
    build:
      context: ./frontend
      dockerfile: e2e.Dockerfile # note: using the e2e Dockerfile
    container_name: e2e-test
    environment:
      - BASE_URL=http://frontend:3000
    volumes:
      - ./frontend:/app
    command:
      - sh
      - -c
      - |
        echo "Container up and running..." &&
        corepack enable && yarn install &&
        yarn playwright install-deps &&
        yarn playwright install &&
        yarn playwright test &&
        yarn playwright show-report
